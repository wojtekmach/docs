<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.30.9">
    <meta name="project" content="diameter v2.3">


    <title>diameter_app â€” diameter v2.3</title>
    <link rel="stylesheet" href="dist/html-erlang-QW5RMTQD.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-43PMFBC7.js"></script>
    <script src="dist/sidebar_items-B01FCB41.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-LRUIU55G.js"></script>

<style>.dark img { background-color: white; }</style>
  </head>
  <body data-type="modules" class="page-behaviour">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="api-reference.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="diameter" />
        </a>

      <div>
        <a href="api-reference.html" class="sidebar-projectName" translate="no">
diameter
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.3
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


</nav>

<main class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">
      <div class="top-search">
        <div class="search-settings">
          <form class="search-bar" action="search.html">
            <label class="search-label">
              <span class="sr-only">Search documentation of diameter</span>
              <input name="q" type="text" class="search-input" placeholder="Search Documentation (press /)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            </label>
            <button type="submit" class="search-button" aria-label="Submit Search">
              <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
            </button>
            <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
              <i class="ri-close-line ri-lg" title="Cancel search"></i>
            </button>
          </form>
          <button class="icon-settings display-settings">
            <i class="ri-settings-3-line"></i>
            <span class="sr-only">Settings</span>
          </button>
        </div>
      </div>
      <div class="autocomplete">
        <div class="autocomplete-results">
        </div>
      </div>

<h1>

    <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/diameter_app.erl#L21" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span translate="no">diameter_app</span> <small>behaviour</small>
  <small class="app-vsn" translate="no">(diameter v2.3)</small>

</h1>


  <section id="moduledoc">
<p>Callback module of a Diameter application.</p><p>A diameter service as started by <a href="diameter.html#start_service/2"><code class="inline">diameter:start_service/2</code></a> configures one of
more Diameter applications, each of whose configuration specifies a callback
that handles messages specific to the application. The messages and AVPs of the
application are defined in a dictionary file whose format is documented in
<a href="diameter_dict.html">diameter_dict(4)</a> while the callback module is documented
here. The callback module implements the Diameter application-specific
functionality of a service.</p><p>A callback module must export all of the functions documented below. The
functions themselves are of three distinct flavours:</p><ul><li><a href="#c:peer_up/3"><code class="inline">peer_up/3</code></a> and <a href="#c:peer_down/3"><code class="inline">peer_down/3</code></a> signal the attainment or loss of
connectivity with a Diameter peer.</li><li><a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a>, <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a>, <a href="#c:prepare_retransmit/3"><code class="inline">prepare_retransmit/3</code></a>,
<a href="#c:handle_answer/4"><code class="inline">handle_answer/4</code></a> and <a href="#c:handle_error/4"><code class="inline">handle_error/4</code></a> are (or may be) called as a
consequence of a call to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> to send an outgoing Diameter
request message.</li><li><a href="#c:handle_request/3"><code class="inline">handle_request/3</code></a> is called in response to an incoming Diameter request
message.</li></ul><p>The arities for the the callback functions here assume no extra arguments. All
functions will also be passed any extra arguments configured with the callback
module itself when calling <a href="diameter.html#start_service/2"><code class="inline">diameter:start_service/2</code></a> and, for the call-specific
callbacks, any extra arguments passed to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a>.</p><h2 id="module-data-types" class="section-heading">
  <a href="#module-data-types" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">DATA TYPES</span>
</h2>
<ul><li><p><strong><code class="inline" id="capabilities">capabilities() = #diameter_caps{}</code></strong> - A record
containing the identities of the local Diameter node and the remote Diameter
peer having an established transport connection, as well as the capabilities
as determined by capabilities exchange. Each field of the record is a 2-tuple
consisting of values for the (local) host and (remote) peer. Optional or
possibly multiple values are encoded as lists of values, mandatory values as
the bare value.</p></li><li><p><strong><code class="inline" id="message">message() =</code><a href="diameter_codec.html#message"><code class="inline" id="message">diameter_codec:message()</code></a></strong> -
The representation of a Diameter message as passed to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> or
returned from a <a href="#c:handle_request/3"><code class="inline">handle_request/3</code></a> callback.</p></li><li><p><strong><code class="inline" id="packet">packet() =</code><a href="diameter_codec.html#packet"><code class="inline" id="packet">diameter_codec:packet()</code></a></strong> - A
container for incoming and outgoing Diameter messages that's passed through
encode/decode and transport. Fields should not be set in return values except
as documented.</p></li><li><p><strong><code class="inline" id="peer_ref">peer_ref() = term()</code></strong> - A term identifying a transport
connection with a Diameter peer.</p></li><li><p><strong><code class="inline" id="peer">peer() = {</code><a href="diameter_app.html#peer_ref"><code class="inline" id="peer">peer_ref()</code></a><code class="inline" id="peer">,</code><a href="diameter_app.html#capabilities"><code class="inline" id="peer">capabilities()</code></a><code class="inline" id="peer">}</code></strong> - A tuple representing a Diameter peer connection.</p></li><li><p><strong><code class="inline" id="state">state() = term()</code></strong> - The state maintained by the application
callback functions <a href="#c:peer_up/3"><code class="inline">peer_up/3</code></a>, <a href="#c:peer_down/3"><code class="inline">peer_down/3</code></a> and (optionally)
<a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a>. The initial state is configured in the call to
<a href="diameter.html#start_service/2"><code class="inline">diameter:start_service/2</code></a> that configures the application on a service.
Callback functions returning a state are evaluated in a common
service-specific process while those not returning state are evaluated in a
request-specific process.</p></li></ul><p><a href="" id="peer_up"></a></p>
  </section>


  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Summary</span>
    </h1>
<div class="summary-types summary">
  <h2>
    <a href="#types">Types</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:capabilities/0" translate="no">capabilities/0</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:message/0" translate="no">message/0</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:packet/0" translate="no">packet/0</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:peer/0" translate="no">peer/0</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:peer_ref/0" translate="no">peer_ref/0</a>

      </div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#t:state/0" translate="no">state/0</a>

      </div>

    </div>

</div>
<div class="summary-callbacks summary">
  <h2>
    <a href="#callbacks">Callbacks</a>
  </h2>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:handle_answer/4" translate="no">handle_answer(Packet, Request, SvcName, Peer)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked when an answer message is received from a peer. The return value is
returned from <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> unless the <code class="inline">detach</code> option was specified.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:handle_error/4" translate="no">handle_error(Reason, Request, SvcName, Peer)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked when an error occurs before an answer message is received in response to
an outgoing request. The return value is returned from <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> unless
the <code class="inline">detach</code> option was specified.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:handle_request/3" translate="no">handle_request(Packet, SvcName, Peer)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked when a request message is received from a peer. The application in which
the callback takes place (that is, the callback module as configured with
<a href="diameter.html#start_service/2"><code class="inline">diameter:start_service/2</code></a>) is determined by the Application Identifier in the
header of the incoming request message, the selected module being the one whose
corresponding dictionary declares itself as defining either the application in
question or the Relay application.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:peer_down/3" translate="no">peer_down(SvcName, Peer, State)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked to signal that a peer connection on the local Erlang node is no longer
available following a previous call to <a href="#c:peer_up/3"><code class="inline">peer_up/3</code></a>. In particular, that the
RFC 3539 watchdog state machine for the connection has left state <code class="inline">OKAY</code> and the
peer will no longer be a candidate in <a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a> callbacks.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:peer_up/3" translate="no">peer_up(SvcName, Peer, State)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked to signal the availability of a peer connection on the local Erlang
node. In particular, capabilities exchange with the peer has indicated support
for the application in question, the RFC 3539 watchdog state machine for the
connection has reached state <code class="inline">OKAY</code> and Diameter messages can be both sent and
received.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:pick_peer/4" translate="no">pick_peer(LocalCandidates, RemoteCandidates, SvcName, State)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked as a consequence of a call to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> to select a destination
peer for an outgoing request. The return value indicates the selected peer.</p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:prepare_request/3" translate="no">prepare_request(Packet, SvcName, Peer)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked to return a request for encoding and transport. Allows the sender to use
the selected peer's capabilities to modify the outgoing request. Many
implementations may simply want to return <code class="inline">{send, Packet}</code></p></div>

    </div>

    <div class="summary-row">
      <div class="summary-signature">
        <a href="#c:prepare_retransmit/3" translate="no">prepare_retransmit(Packet, SvcName, Peer)</a>

      </div>

        <div class="summary-synopsis"><p>Invoked to return a request for encoding and retransmission. Has the same role
as <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a> in the case that a peer connection is lost an an
alternate peer selected but the argument <a href="diameter_app.html#packet">packet()</a> is
as returned by the initial <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a>.</p></div>

    </div>

</div>

  </section>


  <section id="types" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#types">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Types</span>
    </h1>
    <div class="types-list">
<section class="detail" id="t:capabilities/0">

  <div class="detail-header">
    <a href="#t:capabilities/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">capabilities/0</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L99" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> capabilities() :: #diameter_caps{}.</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:message/0">

  <div class="detail-header">
    <a href="#t:message/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">message/0</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L103" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> message() :: <a href="diameter_codec.html#t:message/0">diameter_codec:message</a>().</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:packet/0">

  <div class="detail-header">
    <a href="#t:packet/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">packet/0</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L101" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> packet() :: <a href="diameter_codec.html#t:packet/0">diameter_codec:packet</a>().</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:peer/0">

  <div class="detail-header">
    <a href="#t:peer/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">peer/0</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L100" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> peer() :: {<a href="#t:peer_ref/0">peer_ref</a>(), <a href="#t:capabilities/0">capabilities</a>()}.</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:peer_ref/0">

  <div class="detail-header">
    <a href="#t:peer_ref/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">peer_ref/0</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L98" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> peer_ref() :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>().</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:state/0">

  <div class="detail-header">
    <a href="#t:state/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">state/0</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L102" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-type</span> state() :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>().</pre>

      </div>


  </section>
</section>

    </div>
  </section>

  <section id="callbacks" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#callbacks">
        <i class="ri-link-m" aria-hidden="true"></i>
      </a>
      <span class="text">Callbacks</span>
    </h1>
    <div class="callbacks-list">
<section class="detail" id="c:handle_answer/4">

  <div class="detail-header">
    <a href="#c:handle_answer/4" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_answer(Packet, Request, SvcName, Peer)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L267" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> handle_answer(Packet, Request, SvcName, Peer) -> Result
                 when
                     Packet :: <a href="#t:packet/0">packet</a>(),
                     Request :: <a href="#t:message/0">message</a>(),
                     SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
                     Peer :: <a href="#t:peer/0">peer</a>(),
                     Result :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>().</pre>

      </div>

<p>Invoked when an answer message is received from a peer. The return value is
returned from <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> unless the <code class="inline">detach</code> option was specified.</p><p>The decoded answer record and undecoded binary are in the <code class="inline">msg</code> and <code class="inline">bin</code> fields
of the argument <a href="diameter_app.html#packet">packet()</a> respectively. <code class="inline">Request</code> is
the outgoing request message as was returned from <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a> or
<a href="#c:prepare_retransmit/3"><code class="inline">prepare_retransmit/3</code></a>.</p><p>For any given call to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> there is at most one <a href="#c:handle_answer/4"><code class="inline">handle_answer/4</code></a>
callback: any duplicate answer (due to retransmission or otherwise) is
discarded. Similarly, only one of <a href="#c:handle_answer/4"><code class="inline">handle_answer/4</code></a> or <a href="#c:handle_error/4"><code class="inline">handle_error/4</code></a> is
called.</p><p>By default, an incoming answer message that cannot be successfully decoded
causes the request process to fail, causing <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> to return
<code class="inline">{error, failure}</code> unless the <code class="inline">detach</code> option was specified. In particular,
there is no <a href="#c:handle_error/4"><code class="inline">handle_error/4</code></a> callback in this case. The
<a href="diameter.html#application_opt">diameter:application_opt()</a> <code class="inline">answer_errors</code> can
be set to change this behaviour.</p>
  </section>
</section>
<section class="detail" id="c:handle_error/4">

  <div class="detail-header">
    <a href="#c:handle_error/4" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_error(Reason, Request, SvcName, Peer)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L238" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> handle_error(Reason, Request, SvcName, Peer) -> Result
                when
                    Reason :: timeout | failover | <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>(),
                    Request :: <a href="#t:message/0">message</a>(),
                    SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
                    Peer :: <a href="#t:peer/0">peer</a>(),
                    Result :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>().</pre>

      </div>

<p>Invoked when an error occurs before an answer message is received in response to
an outgoing request. The return value is returned from <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> unless
the <code class="inline">detach</code> option was specified.</p><p>Reason <code class="inline">timeout</code> indicates that an answer message has not been received within
the time specified with the corresponding
<a href="diameter.html#call_opt">diameter:call_opt()</a>. Reason <code class="inline">failover</code> indicates that
the transport connection to the peer to which the request has been sent has
become unavailable and that not alternate peer was not selected.</p>
  </section>
</section>
<section class="detail" id="c:handle_request/3">

  <div class="detail-header">
    <a href="#c:handle_request/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_request(Packet, SvcName, Peer)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L211" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> handle_request(Packet, SvcName, Peer) -> Action
                  when
                      Packet :: <a href="#t:packet/0">packet</a>(),
                      SvcName :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>(),
                      Peer :: <a href="#t:peer/0">peer</a>(),
                      Action ::
                          Reply | {relay, [Opt]} | discard | {eval | eval_packet, Action, PostF},
                      Reply ::
                          {reply, <a href="#t:packet/0">packet</a>() | <a href="#t:message/0">message</a>()} |
                          {answer_message, 3000..3999 | 5000..5999} |
                          {protocol_error, 3000..3999},
                      Opt :: <a href="diameter.html#t:call_opt/0">diameter:call_opt</a>(),
                      PostF :: <a href="diameter.html#t:eval/0">diameter:eval</a>().</pre>

      </div>

<p>Invoked when a request message is received from a peer. The application in which
the callback takes place (that is, the callback module as configured with
<a href="diameter.html#start_service/2"><code class="inline">diameter:start_service/2</code></a>) is determined by the Application Identifier in the
header of the incoming request message, the selected module being the one whose
corresponding dictionary declares itself as defining either the application in
question or the Relay application.</p><p>The argument <a href="diameter_app.html#packet">packet()</a> has the following signature.</p><pre><code class="text">#diameter_packet{header = #diameter_header{},
                 avps   = [#diameter_avp{}],
                 msg    = record() | undefined,
                 errors = [Unsigned32() | {Unsigned32(), #diameter_avp{}}],
                 bin    = binary(),
                 transport_data = term()}</code></pre><p>The <code class="inline">msg</code> field will be <code class="inline">undefined</code> in case the request has been received in the
relay application. Otherwise it contains the record representing the request as
outlined in <a href="diameter_dict.html#MESSAGE_RECORDS">diameter_dict(4)</a>.</p><p>The <code class="inline">errors</code> field specifies any results codes identifying errors found while
decoding the request. This is used to set Result-Code and/or Failed-AVP in a
returned answer unless the callback returns a <code class="inline">#diameter_packet{}</code> whose
<code class="inline">errors</code> field is set to either a non-empty list of its own, in which case this
list is used instead, or the atom <code class="inline">false</code> to disable any setting of Result-Code
and Failed-AVP. Note that the errors detected by diameter are of the 3xxx and
5xxx series, Protocol Errors and Permanent Failures respectively. The <code class="inline">errors</code>
list is empty if the request has been received in the relay application.</p><p>The <code class="inline">transport_data</code> field contains an arbitrary term passed into diameter from
the transport module in question, or the atom <code class="inline">undefined</code> if the transport
specified no data. The term is preserved if a
<a href="diameter_app.html#message">message()</a> is returned but must be set explicitly in
a returned <a href="diameter_app.html#packet">packet()</a>.</p><p>The semantics of each of the possible return values are as follows.</p><ul><li><p><strong><code class="inline">{reply,</code><a href="diameter_app.html#packet"><code class="inline">packet()</code></a><code class="inline">|</code><a href="diameter_app.html#message"><code class="inline">message()</code></a><code class="inline">}</code></strong> -
Send the specified answer message to the peer. In the case of a
<a href="diameter_app.html#packet">packet()</a>, the message to be sent must be set in the
<code class="inline">msg</code> field and the <code class="inline">header</code> field can be set to a <code class="inline">#diameter_header{}</code> to
specify values that should be preserved in the outgoing answer, appropriate
values otherwise being set by diameter.</p></li><li><p><strong><code class="inline">{answer_message, 3000..3999|5000..5999}</code></strong> - Send an answer message to the
peer containing the specified Result-Code. Equivalent to</p><pre><code class="text">{reply, ['answer-message' | Avps]</code></pre><p>where <code class="inline">Avps</code> sets the Origin-Host, Origin-Realm, the specified Result-Code and
(if the request contained one) Session-Id AVPs, and possibly Failed-AVP as
described below.</p><p>Returning a value other than 3xxx or 5xxx will cause the request process in
question to fail, as will returning a 5xxx value if the peer connection in
question has been configured with the RFC 3588 common dictionary
<code class="inline">diameter_gen_base_rfc3588</code>. (Since RFC 3588 only allows 3xxx values in an
answer-message.)</p><p>When returning 5xxx, Failed-AVP will be populated with the AVP of the first
matching Result-Code/AVP pair in the <code class="inline">errors</code> field of the argument
<a href="diameter_app.html#packet">packet()</a>, if found. If this is not appropriate then
an answer-message should be constructed explicitly and returned in a <code class="inline">reply</code>
tuple instead.</p></li><li><p><strong><code class="inline">{relay, Opts}</code></strong> - Relay a request to another peer in the role of a
Diameter relay agent. If a routing loop is detected then the request is
answered with 3005 (DIAMETER_LOOP_DETECTED). Otherwise a Route-Record AVP
(containing the sending peer's Origin-Host) is added to the request and
<a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a> and subsequent callbacks take place just as if
<a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> had been called explicitly. The End-to-End Identifier of the
incoming request is preserved in the header of the relayed request.</p><p>The returned <code class="inline">Opts</code> should not specify <code class="inline">detach</code>. A subsequent
<a href="#c:handle_answer/4"><code class="inline">handle_answer/4</code></a> callback for the relayed request must return its first
argument, the <a href="diameter_app.html#packet">packet()</a> containing the answer
message. Note that the <code class="inline">extra</code> option can be specified to supply arguments
that can distinguish the relay case from others if so desired. Any other
return value (for example, from a <a href="#c:handle_error/4"><code class="inline">handle_error/4</code></a> callback) causes the
request to be answered with 3002 (DIAMETER_UNABLE_TO_DELIVER).</p></li><li><p><strong><code class="inline">discard</code></strong> - Discard the request. No answer message is sent to the peer.</p></li><li><p><strong><code class="inline">{eval, Action, PostF}</code></strong> - Handle the request as if <code class="inline">Action</code> has been
returned and then evaluate <code class="inline">PostF</code> in the request process. The return value is
ignored.</p></li><li><p><strong><code class="inline">{eval_packet, Action, PostF}</code></strong> - Like <code class="inline">eval</code> but evaluate <code class="inline">PostF</code> on any
encoded <code class="inline">#diameter_packet{}</code> prior to transmission, the <code class="inline">bin</code> field containing
the encoded binary. The return value is ignored.</p></li><li><p><strong><code class="inline">{protocol_error, 3000..3999}</code></strong> - Equivalent to
<code class="inline">{answer_message, 3000..3999}</code>.</p></li></ul><blockquote><h4 class="info">Note</h4><p>Requests containing errors may be answered by diameter, without a callback
taking place, depending on the value of the
<a href="diameter.html#application_opt">diameter:application_opt()</a> <code class="inline">request_errors</code>.</p></blockquote>
  </section>
</section>
<section class="detail" id="c:peer_down/3">

  <div class="detail-header">
    <a href="#c:peer_down/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">peer_down(SvcName, Peer, State)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L393" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> peer_down(SvcName, Peer, State) -> NewState
             when
                 SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
                 Peer :: <a href="#t:peer/0">peer</a>(),
                 State :: <a href="#t:state/0">state</a>(),
                 NewState :: <a href="#t:state/0">state</a>().</pre>

      </div>

<p>Invoked to signal that a peer connection on the local Erlang node is no longer
available following a previous call to <a href="#c:peer_up/3"><code class="inline">peer_up/3</code></a>. In particular, that the
RFC 3539 watchdog state machine for the connection has left state <code class="inline">OKAY</code> and the
peer will no longer be a candidate in <a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a> callbacks.</p>
  </section>
</section>
<section class="detail" id="c:peer_up/3">

  <div class="detail-header">
    <a href="#c:peer_up/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">peer_up(SvcName, Peer, State)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L419" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> peer_up(SvcName, Peer, State) -> NewState
           when
               SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
               Peer :: <a href="#t:peer/0">peer</a>(),
               State :: <a href="#t:state/0">state</a>(),
               NewState :: <a href="#t:state/0">state</a>().</pre>

      </div>

<p>Invoked to signal the availability of a peer connection on the local Erlang
node. In particular, capabilities exchange with the peer has indicated support
for the application in question, the RFC 3539 watchdog state machine for the
connection has reached state <code class="inline">OKAY</code> and Diameter messages can be both sent and
received.</p><blockquote><h4 class="info">Note</h4><p>A watchdog state machine can reach state <code class="inline">OKAY</code> from state <code class="inline">SUSPECT</code> without a
new capabilities exchange taking place. A new transport connection (and
capabilities exchange) results in a new peer_ref().</p></blockquote><blockquote><h4 class="info">Note</h4><p>There is no requirement that a callback return before incoming requests are
received: <a href="#c:handle_request/3"><code class="inline">handle_request/3</code></a> callbacks must be handled independently of
<a href="#c:peer_up/3"><code class="inline">peer_up/3</code></a> and <a href="#c:peer_down/3"><code class="inline">peer_down/3</code></a>.</p></blockquote>
  </section>
</section>
<section class="detail" id="c:pick_peer/4">

  <div class="detail-header">
    <a href="#c:pick_peer/4" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">pick_peer(LocalCandidates, RemoteCandidates, SvcName, State)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L376" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> pick_peer(LocalCandidates, RemoteCandidates, SvcName, State) -> Selection | false
             when
                 LocalCandidates :: [<a href="#t:peer/0">peer</a>()],
                 RemoteCandidates :: [<a href="#t:peer/0">peer</a>()],
                 SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
                 State :: <a href="#t:state/0">state</a>(),
                 NewState :: <a href="#t:state/0">state</a>(),
                 Selection :: {ok, Peer} | {Peer, NewState},
                 Peer :: <a href="#t:peer/0">peer</a>() | false.</pre>

      </div>

<p>Invoked as a consequence of a call to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> to select a destination
peer for an outgoing request. The return value indicates the selected peer.</p><p>The candidate lists contain only those peers that have advertised support for
the Diameter application in question during capabilities exchange, that have not
be excluded by a <code class="inline">filter</code> option in the call to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> and whose
watchdog state machine is in the <code class="inline">OKAY</code> state. The order of the elements is
unspecified except that any peers whose Origin-Host and Origin-Realm matches
that of the outgoing request (in the sense of a <code class="inline">{filter, {all, [host, realm]}}</code>
option to <a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a>) will be placed at the head of the list.
<code class="inline">LocalCandidates</code> contains peers whose transport process resides on the local
Erlang node while <code class="inline">RemoteCandidates</code> contains peers that have been communicated
from other nodes by services of the same name.</p><p>A callback that returns a peer() will be followed by a <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a>
callback and, if the latter indicates that the request should be sent, by either
<a href="#c:handle_answer/4"><code class="inline">handle_answer/4</code></a> or <a href="#c:handle_error/4"><code class="inline">handle_error/4</code></a> depending on whether or not an answer
message is received from the peer. If the transport becomes unavailable after
<a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a> then a new <a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a> callback may take place to
failover to an alternate peer, after which <a href="#c:prepare_retransmit/3"><code class="inline">prepare_retransmit/3</code></a> takes the
place of <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a> in resending the request. There is no guarantee
that a <a href="#c:pick_peer/4"><code class="inline">pick_peer/4</code></a> callback to select an alternate peer will be followed by
any additional callbacks since a retransmission to an alternate peer is
abandoned if an answer is received from a previously selected peer.</p><p>The return values <code class="inline">false</code> and <code class="inline">{false, State}</code> (that is, <code class="inline">NewState = State</code>) are
equivalent, as are <code class="inline">{ok, Peer}</code> and <code class="inline">{Peer, State}</code>.</p><blockquote><h4 class="info">Note</h4><p>The <a href="diameter.html#service_opt">diameter:service_opt()</a> <code class="inline">use_shared_peers</code>
determines whether or not a service uses peers shared from other nodes. If not
then <code class="inline">RemoteCandidates</code> is the empty list.</p></blockquote><blockquote><h4 class="warning">Warning</h4><p>The return value <code class="inline">{Peer, NewState}</code> is only allowed if the Diameter
application in question was configured with the
<a href="diameter.html#application_opt">diameter:application_opt()</a>
<code class="inline">{call_mutates_state, true}</code>. Otherwise, the <code class="inline">State</code> argument is always the
initial value as configured on the application, not any subsequent value
returned by a <a href="#c:peer_up/3"><code class="inline">peer_up/3</code></a> or <a href="#c:peer_down/3"><code class="inline">peer_down/3</code></a> callback.</p></blockquote>
  </section>
</section>
<section class="detail" id="c:prepare_request/3">

  <div class="detail-header">
    <a href="#c:prepare_request/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">prepare_request(Packet, SvcName, Peer)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L321" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> prepare_request(Packet, SvcName, Peer) -> Action
                   when
                       Packet :: <a href="#t:packet/0">packet</a>(),
                       SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
                       Peer :: <a href="#t:peer/0">peer</a>(),
                       Action :: Send | Discard | {eval_packet, Action, PostF},
                       Send :: {send, <a href="#t:packet/0">packet</a>() | <a href="#t:message/0">message</a>()},
                       Discard :: {discard, Reason :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>()} | discard,
                       PostF :: <a href="diameter.html#t:eval/0">diameter:eval</a>().</pre>

      </div>

<p>Invoked to return a request for encoding and transport. Allows the sender to use
the selected peer's capabilities to modify the outgoing request. Many
implementations may simply want to return <code class="inline">{send, Packet}</code></p><p>A returned <a href="diameter_app.html#packet">packet()</a> should set the request to be
encoded in its <code class="inline">msg</code> field and can set the <code class="inline">transport_data</code> field in order to
pass information to the transport process. Extra arguments passed to
<a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> can be used to communicate transport (or any other) data to
the callback.</p><p>A returned <a href="diameter_app.html#packet">packet()</a> can set the <code class="inline">header</code> field to a
<code class="inline">#diameter_header{}</code> to specify values that should be preserved in the outgoing
request, values otherwise being those in the header record contained in
<code class="inline">Packet</code>. A returned <code class="inline">length</code>, <code class="inline">cmd_code</code> or <code class="inline">application_id</code> is ignored.</p><p>A returned <code class="inline">PostF</code> will be evaluated on any encoded <code class="inline">#diameter_packet{}</code> prior
to transmission, the <code class="inline">bin</code> field containing the encoded binary. The return value
is ignored.</p><p>Returning <code class="inline">{discard, Reason}</code> causes the request to be aborted and the
<a href="diameter.html#call/4"><code class="inline">diameter:call/4</code></a> for which the callback has taken place to return
<code class="inline">{error, Reason}</code>. Returning <code class="inline">discard</code> is equivalent to returning
<code class="inline">{discard, discarded}</code>.</p>
  </section>
</section>
<section class="detail" id="c:prepare_retransmit/3">

  <div class="detail-header">
    <a href="#c:prepare_retransmit/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">prepare_retransmit(Packet, SvcName, Peer)</h1>

      <a href="https://github.com/erlang/otp/blob/master/lib/diameter/doc//Users/wojtek/src/otp/lib/diameter/src/base/base/diameter_app.erl#L285" class="icon-action" rel="help" title="View Source">
       <i class="ri-code-s-slash-line" aria-hidden="true"></i>
       <span class="sr-only">View Source</span>
     </a>


      <span class="note">(since OTP R14B03)</span>

  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">-callback</span> prepare_retransmit(Packet, SvcName, Peer) -> Action
                      when
                          Packet :: <a href="#t:packet/0">packet</a>(),
                          SvcName :: <a href="diameter.html#t:service_name/0">diameter:service_name</a>(),
                          Peer :: <a href="#t:peer/0">peer</a>(),
                          Action :: Send | Discard | {eval_packet, Action, PostF},
                          Send :: {send, <a href="#t:packet/0">packet</a>() | <a href="#t:message/0">message</a>()},
                          Discard :: {discard, Reason :: <a href="../../../../lib/../erts/doc/html/erlang.html#t:term/0">term</a>()} | discard,
                          PostF :: <a href="diameter.html#t:eval/0">diameter:eval</a>().</pre>

      </div>

<p>Invoked to return a request for encoding and retransmission. Has the same role
as <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a> in the case that a peer connection is lost an an
alternate peer selected but the argument <a href="diameter_app.html#packet">packet()</a> is
as returned by the initial <a href="#c:prepare_request/3"><code class="inline">prepare_request/3</code></a>.</p><p>Returning <code class="inline">{discard, Reason}</code> causes the request to be aborted and a
<a href="#c:handle_error/4"><code class="inline">handle_error/4</code></a> callback to take place with <code class="inline">Reason</code> as initial argument.
Returning <code class="inline">discard</code> is equivalent to returning <code class="inline">{discard, discarded}</code>.</p>
  </section>
</section>

    </div>
  </section>

      <footer class="footer">
        <p>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.30.9) for the

            <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

        </p>
      </footer>
    </div>
  </div>
</main>
</div>


  </body>
</html>
